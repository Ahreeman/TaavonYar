pipeline {
  agent any

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Build') {
      steps {
        sh 'ls -la'
        sh 'ls -la backend | head -n 50'
        sh 'docker compose -f docker-compose.yml -f docker-compose.ci.yml build --no-cache'
      }
    }

  stage('Test') {
      steps {
          // 1. Start the database
          sh 'docker compose -f docker-compose.yml -f docker-compose.ci.yml up -d db'
          
          // 2. Optional: Wait for DB to be ready (if you don't have a wait script)
          sh 'sleep 10' 

          // 3. Run pytest
          // We override the CMD to run pytest instead of the server
          sh 'docker compose -f docker-compose.yml -f docker-compose.ci.yml run --rm web pytest'
      }
    }

  stage('Deploy Locally') {
      steps {
          script {
              echo "Starting application for manual testing at http://localhost:8000"
              // Start everything in detached mode (-d)
              // This uses the built images to run the server
              sh 'docker compose -f docker-compose.yml -f docker-compose.ci.yml up -d web'
          }
      }
    }
  }

  post {
    always {
      sh 'docker compose -f docker-compose.yml -f docker-compose.ci.yml logs --no-color || true'
    }
  }
}
