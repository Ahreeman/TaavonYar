{% extends "core/base.html" %}
{% block title %}Marketplace - TaavonYar{% endblock %}

{% block content %}
<h1 class="h4 mb-3">Marketplace</h1>

<div class="row g-3">
  <div class="col-lg-4">
    <div class="card mb-3">
      <div class="card-body">
        <h2 class="h6">Filter by Cooperative</h2>
        <form method="get" action="{% url 'shares:marketplace' %}">
          <select class="form-select mb-2" name="coop">
            <option value="">All cooperatives</option>
            {% for c in all_coops %}
              <option value="{{ c.id }}" {% if selected_coop_id == c.id|stringformat:"s" %}selected{% endif %}>
                {{ c.name }}
              </option>
            {% endfor %}
          </select>
          <button class="btn btn-outline-dark w-100" type="submit">Apply</button>
        </form>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <h2 class="h6">Sell Shares (Create Listing)</h2>
        <form method="post" action="{% url 'shares:create_listing' %}">
          {% csrf_token %}
          <label class="form-label">Cooperative</label>
          <select class="form-select mb-2" name="coop_id" required>
            {% for c in all_coops %}
              <option value="{{ c.id }}">{{ c.name }}</option>
            {% endfor %}
          </select>

          <label class="form-label">Quantity</label>
          <input class="form-control mb-2" type="number" name="quantity" min="1" required>

          <button class="btn btn-outline-dark w-100" type="submit">Create Listing</button>
        </form>

        <div class="text-muted small mt-2">
          Marketplace price is always the cooperativeâ€™s price_per_share.
        </div>

        <div class="mt-3 d-flex gap-2">
          <a class="btn btn-outline-dark w-100" href="{% url 'shares:my_listings' %}">My Listings</a>
          <a class="btn btn-outline-dark w-100" href="{% url 'shares:my_trades' %}">My Trades</a>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-8">
    <div class="card">
      <div class="card-body">
        <h2 class="h6">Available Shares by Cooperative</h2>

        {% if rows %}
          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>Cooperative</th>
                  <th class="text-end">Price/share (Tooman)</th>
                  <th class="text-end">Primary</th>
                  <th class="text-end">Secondary</th>
                  <th class="text-end">Total</th>
                  <th style="width: 240px;">Buy</th>
                </tr>
              </thead>
              <tbody>
                {% for r in rows %}
                  <tr>
                    <td>
                      <div class="fw-semibold">{{ r.coop.name }}</div>
                      <div class="text-muted small">{{ r.coop.village }}</div>
                    </td>
                    <td class="text-end">{{ r.coop.price_per_share }}</td>
                    <td class="text-end">{{ r.primary }}</td>
                    <td class="text-end">{{ r.secondary }}</td>
                    <td class="text-end fw-semibold">{{ r.total_for_buyer }}</td>
                    <td>
                      {% if r.total_for_buyer > 0 %}
                        <form method="post" action="{% url 'shares:buy_marketplace' %}" class="d-flex gap-2 align-items-center">
                            {% csrf_token %}
                            <input type="hidden" name="coop_id" value="{{ r.coop.id }}">

                            <select class="form-select form-select-sm" name="source" style="width: 140px;">
                              <option value="auto" selected>Auto</option>

                              <option value="primary"
                                      {% if r.primary == 0 %}disabled{% endif %}>
                                Primary{% if r.primary == 0 %} (none){% endif %}
                              </option>

                              <option value="secondary"
                                      {% if r.secondary == 0 %}disabled{% endif %}>
                                Secondary{% if r.secondary == 0 %} (none){% endif %}
                              </option>
                            </select>

                            <input class="form-control form-control-sm" style="width: 90px;"
                                  type="number" name="quantity" min="1" max="{{ r.total_for_buyer }}" required>

                            <button class="btn btn-sm btn-dark" type="submit">Buy</button>
                        </form>
                        {% else %}
                          <span class="text-muted small">No shares available</span>
                        {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="alert alert-info mb-0">No cooperatives available.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
