{% extends "core/base.html" %}
{% block title %}Shareholder Dashboard - TaavonYar{% endblock %}

{% block content %}
<h1 class="h4 mb-3">Shareholder Dashboard</h1>

<div class="card mb-3">
  <div class="card-body">
    <h2 class="h6 mb-2">My User ID</h2>
    {% if shareholder_id %}
      <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
        <code id="shareholder-id-text" class="px-2 py-1 border rounded bg-light">{{ shareholder_id }}</code>
        <button id="copy-shareholder-id-btn" class="btn btn-sm btn-outline-dark" type="button">Copy ID</button>
        <button id="share-shareholder-id-btn" class="btn btn-sm btn-dark" type="button">Share</button>
      </div>
      <div class="text-muted small">Share this ID with board members so they can add you to a cooperative board.</div>

      {% if qr_image_url %}
        <div class="mt-3">
          <div class="small text-muted mb-1">QR code</div>
          <img src="{{ qr_image_url }}" width="180" height="180" alt="QR code for shareholder ID {{ shareholder_id }}" class="border rounded">
        </div>
      {% endif %}

      {{ share_payload|json_script:"shareholder-share-payload" }}
      <script>
        (function () {
          const idText = document.getElementById("shareholder-id-text")?.textContent?.trim() || "";
          const payloadEl = document.getElementById("shareholder-share-payload");
          const payload = payloadEl ? JSON.parse(payloadEl.textContent) : idText;

          const copyBtn = document.getElementById("copy-shareholder-id-btn");
          if (copyBtn) {
            copyBtn.addEventListener("click", async function () {
              try {
                await navigator.clipboard.writeText(idText);
                copyBtn.textContent = "Copied!";
                setTimeout(() => (copyBtn.textContent = "Copy ID"), 1200);
              } catch (e) {
                copyBtn.textContent = "Copy failed";
                setTimeout(() => (copyBtn.textContent = "Copy ID"), 1200);
              }
            });
          }

          const shareBtn = document.getElementById("share-shareholder-id-btn");
          if (shareBtn) {
            if (navigator.share) {
              shareBtn.addEventListener("click", async function () {
                try {
                  await navigator.share({
                    title: "My TaavonYar User ID",
                    text: payload,
                  });
                } catch (e) {
                  // user canceled or unsupported payload
                }
              });
            } else {
              shareBtn.disabled = true;
              shareBtn.title = "Browser share is not available";
            }
          }
        })();
      </script>
    {% else %}
      <div class="alert alert-warning mb-0">No shareholder ID found for your account.</div>
    {% endif %}
  </div>
</div>


<div class="mb-3 d-flex gap-2 flex-wrap">
  <a class="btn btn-outline-dark" href="{% url 'shares:export_my_holdings_csv' %}">Export My Holdings CSV</a>
  <a class="btn btn-outline-dark" href="{% url 'shares:export_my_contributions_csv' %}">Export My Contributions CSV</a>
  <a class="btn btn-outline-dark" href="{% url 'shares:export_my_trade_logs_csv' %}">Export My Trade Logs CSV</a>
</div>


<div class="row g-3">
  <div class="col-lg-6">
    <div class="card">
      <div class="card-body">
        <h2 class="h6">My Portfolio</h2>   
        
        
        <div class="card mb-3">
          <div class="card-body">
            <h2 class="h6 mb-3">My Portfolio Distribution (by share count)</h2>
            <canvas id="portfolioPieChart" height="120"></canvas>
            <div id="portfolioEmptyMsg" class="text-muted small mt-2 d-none">
              No shares yet to visualize.
            </div>
          </div>
        </div>

        {{ portfolio_labels_json|default:"[]"|json_script:"portfolio-labels-data" }}
        {{ portfolio_values_json|default:"[]"|json_script:"portfolio-values-data" }}

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
          const portfolioLabels = JSON.parse(document.getElementById("portfolio-labels-data").textContent);
          const portfolioValues = JSON.parse(document.getElementById("portfolio-values-data").textContent);

          const ctx = document.getElementById("portfolioPieChart");
          const emptyMsg = document.getElementById("portfolioEmptyMsg");

          if (ctx && typeof Chart !== "undefined" && portfolioLabels.length && portfolioValues.length) {
            new Chart(ctx, {
              type: "pie",
              data: {
                labels: portfolioLabels,
                datasets: [{ data: portfolioValues }]
              },
              options: { plugins: { legend: { position: "bottom" } } }
            });
          } else if (emptyMsg) {
            emptyMsg.classList.remove("d-none");
          }
        </script>
        

        {% if holdings %}
          <div class="list-group">
            {% for h in holdings %}
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-semibold">{{ h.cooperative.name }}</div>
                  <div class="text-muted small">Price/share: {{ h.cooperative.price_per_share }} Tooman</div>
                </div>
                <div class="text-end">
                  <div class="fw-semibold">{{ h.quantity }} shares</div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="alert alert-info mb-0">You don’t own any shares yet.</div>
        {% endif %}
        <div class="mt-3">
          <a class="btn btn-outline-dark" href="{% url 'shares:marketplace' %}">Go to Marketplace</a>
        </div>
        <div class="mt-2 d-flex gap-2">
          <a class="btn btn-outline-dark" href="{% url 'shares:my_listings' %}">My Listings</a>
          <a class="btn btn-outline-dark" href="{% url 'shares:my_trades' %}">My Trades</a>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card">
      <div class="card-body">
        <h2 class="h6">My Contributions (latest 20)</h2>
        {% if contributions %}
          <div class="list-group">
            {% for c in contributions %}
              <div class="list-group-item">
                <div class="fw-semibold">{{ c.project.title }}</div>
                <div class="text-muted small">
                  {{ c.project.cooperative.name }} • {{ c.amount }} Tooman
                  {% if c.allocated_shares != None %}
                    • Allocated shares: <b>{{ c.allocated_shares }}</b>
                  {% else %}
                    • <i>Waiting for project to be Done</i>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="alert alert-info mb-0">No contributions yet.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
